<!DOCTYPE html><html><head>
      <title>index</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h1 class="mume-header" id="sql-essentials">SQL Essentials</h1>

<blockquote>A workshop provided by the <strong>Cathie Marsh Institute (CMI)</strong> at the University of Manchester on 22nd June 2021</blockquote>
<h2>Workshop outline</h2>
<p>A 3 hour workshop on SQL can be little more than a broad introduction to the topic. You will not leave proficient in SQL. The aim is to give you the confidence to write your own SQL queries to solve simple data manipulation and analysis tasks by adapting the simple queries that we will develop this afternoon to your own data.</p>
<p>The workshop is broken up into four sections.</p>
<ol>
<li>
<p>We will start by explaining what a database is and some of the key components of databases and tables. We will then demonstrate the use of the DB Browser software which we will use to create and run our SQL queries.</p>
</li>
<li>
<p>We will cover the various clauses in the SELECT statement. The majority of SQL that you will ever write will be SELECT statements!</p>
</li>
<li>
<p>We will look at the various ways in which database tables can be created from scratch.</p>
</li>
<li>
<p>We will look at how database tables can be joined together and queried in order to create more complex queries (which answer more complex questions about the data).</p>
</li>
</ol>
<p>The workshop is based on the Data Carpentry for Social Sciences Python lesson which is freely available online at <a href="https://datacarpentry.org/sql-socialsci/">https://datacarpentry.org/sql-socialsci/</a></p>
<h3 class="mume-header" id="download-the-dataset-we-will-be-using">Download the dataset we will be using</h3>

<p>For this workshop we will need two data files. One is a an sqlite database containing the tables that we will be using and the other is the original csv dataset from which one of the tables was created.</p>
<p><a href="./data/SQL_SAFI.sqlite">The SAFI database</a></p>
<p><a href="./data/SAFI_farms.csv">The Farms dataset</a></p>
<p>For now, you can download them to anywhere you like (Desktop, P: drive) - as long as you remember where you left them!</p>
<h2 class="mume-header" id="what-is-a-relational-database">What is a relational database?</h2>

<p>A relational database is a collection of data items organised as a set of tables. Relationships can be defined between the data in one table and the data in another or many other tables. The relational database system will provide mechanisms by which you can query the data in the tables, re-assemble the data in various ways without altering the data in the actual tables.</p>
<p>This querying is usually done using SQL (Structured Query Language). SQL allows a great many queries to be constructed from the use of only a few keywords.</p>
<p>You could have a relational database with only one table, but then you would&#x2019;t have any relationships and it would be more like a spreadsheet.</p>
<p>Databases are designed to allow efficient querying against very large tables, more than the 1M rows allowed in an Excel spreadsheet.</p>
<h2 class="mume-header" id="what-is-a-table">What is a table?</h2>

<p>As were have noted above, a single table is very much like a spreadsheet. It has rows and it has columns. A row represents a single observation and the columns represents the various variables contained within that observation.</p>
<p>Often one or more columns in a row will be designated as a &apos;primary key&apos; This column or combination of columns can be used to uniquely identify a specific row in the table.</p>
<p>The columns typically have a name associated with them indicating the variable name. A column always represents the same variable for each row contained in the table. Because of this the data in each column will always be of the same <em>type</em>, such as an Integer or Text, of values for all of the rows in the table. Datatypes are discussed in the next section.</p>
<h2 class="mume-header" id="what-is-a-data-type">What is a data type?</h2>

<p>A data type is a description of the kind of data in a table column. Each database system recognises its own set of datatypes, although some are common to many.<br>
Typical examples will be Integer or Text.</p>
<p>The table below gives some examples.</p>
<table>
<thead>
<tr>
<th>Data type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHARACTER(n)</td>
<td style="text-align:left">Character string. Fixed-length n</td>
</tr>
<tr>
<td>Text</td>
<td style="text-align:left">Character string. Variable length</td>
</tr>
<tr>
<td>VARCHAR(n) or CHARACTER VARYING(n)</td>
<td style="text-align:left">Character string. Variable length. Maximum length n</td>
</tr>
<tr>
<td>BINARY(n)</td>
<td style="text-align:left">Binary string. Fixed-length n</td>
</tr>
<tr>
<td>BOOLEAN</td>
<td style="text-align:left">Stores TRUE or FALSE values</td>
</tr>
<tr>
<td>VARBINARY(n) or BINARY VARYING(n)</td>
<td style="text-align:left">Binary string. Variable length. Maximum length n</td>
</tr>
<tr>
<td>INTEGER(p)</td>
<td style="text-align:left">Integer numerical (no decimal).</td>
</tr>
<tr>
<td>SMALLINT</td>
<td style="text-align:left">Integer numerical (no decimal).</td>
</tr>
<tr>
<td>INTEGER</td>
<td style="text-align:left">Integer numerical (no decimal).</td>
</tr>
<tr>
<td>BIGINT</td>
<td style="text-align:left">Integer numerical (no decimal).</td>
</tr>
<tr>
<td>DECIMAL(p,s)</td>
<td style="text-align:left">Exact numerical, precision p, scale s.</td>
</tr>
<tr>
<td>NUMERIC(p,s)</td>
<td style="text-align:left">Exact numerical, precision p, scale s. (Same as DECIMAL)</td>
</tr>
<tr>
<td>FLOAT(p)</td>
<td style="text-align:left">Approximate numerical, mantissa precision p. A floating number in base 10 exponential notation.</td>
</tr>
<tr>
<td>REAL</td>
<td style="text-align:left">Approximate numerical</td>
</tr>
<tr>
<td>FLOAT</td>
<td style="text-align:left">Approximate numerical</td>
</tr>
<tr>
<td>DOUBLE PRECISION</td>
<td style="text-align:left">Approximate numerical</td>
</tr>
<tr>
<td>DATE</td>
<td style="text-align:left">Stores year, month, and day values</td>
</tr>
<tr>
<td>TIME</td>
<td style="text-align:left">Stores hour, minute, and second values</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td style="text-align:left">Stores year, month, day, hour, minute, and second values</td>
</tr>
<tr>
<td>INTERVAL</td>
<td style="text-align:left">Composed of a number of integer fields, representing a period of time, depending on the type of interval</td>
</tr>
<tr>
<td>ARRAY</td>
<td style="text-align:left">A set-length and ordered collection of elements</td>
</tr>
<tr>
<td>MULTISET</td>
<td style="text-align:left">A variable-length and unordered collection of elements</td>
</tr>
<tr>
<td>XML</td>
<td style="text-align:left">Stores XML data</td>
</tr>
</tbody>
</table>
<p>But in practice you can usually restrict your usage to a few</p>
<table>
<thead>
<tr>
<th>Data type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>BOOLEAN</td>
<td style="text-align:left">Stores TRUE or FALSE values</td>
</tr>
<tr>
<td>INTEGER</td>
<td style="text-align:left">Integer numerical (no decimal).</td>
</tr>
<tr>
<td>FLOAT</td>
<td style="text-align:left">Approximate numerical</td>
</tr>
<tr>
<td>DATE</td>
<td style="text-align:left">Stores year, month, and day values</td>
</tr>
<tr>
<td>TIME</td>
<td style="text-align:left">Stores hour, minute, and second values</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td style="text-align:left">Stores year, month, day, hour, minute, and second values</td>
</tr>
</tbody>
</table>
<p>In SQLite there is only a small number.</p>
<table>
<thead>
<tr>
<th>Data type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>NULL</td>
<td style="text-align:left">The value is a NULL value</td>
</tr>
<tr>
<td>INTEGER</td>
<td style="text-align:left">The value is a signed integer, stored in 1, 2, 3, 4, 6,</td>
</tr>
<tr>
<td></td>
<td style="text-align:left">or 8 bytes depending on the magnitude of the value</td>
</tr>
<tr>
<td>REAL</td>
<td style="text-align:left">The value is a floating point value, stored in 8-bytes</td>
</tr>
<tr>
<td>TEXT</td>
<td style="text-align:left">The value is a text string</td>
</tr>
<tr>
<td>BLOB</td>
<td style="text-align:left">The data is stored exactly as it was input, Used for binary</td>
</tr>
<tr>
<td></td>
<td style="text-align:left">data such as images.</td>
</tr>
</tbody>
</table>
<p>We won&apos;t be using any BLOB data and it is debatable whether or not NULL should be considered a type at all.</p>
<p>There are some common datatypes which are missing from the SQLite list.</p>
<p>BOOL or BOOLEAN : This type typicaly accepts values of &apos;True&apos; and &apos;False&apos; In SQLite we would use the Integer type and assign vlaues of 1 to represent &apos;True&apos; and 0 to represent &apos;False&apos;.</p>
<p>DATE, DATETIME, TIMESTAMP : SQLite does not have a datatype for storing dates and/or times. You can use TEXT, REAL, or INTEGER values for these and use the built-in Date And Time Functions to manipulate them. We will look at manipulating dates later in the workshop.</p>
<h2 class="mume-header" id="why-do-tables-have-primary-key-columns">Why do tables have primary key columns?</h2>

<p>Whenever you create a table, you will have the option of designating one of the columns as the primary key column. The main property of the primary key column is that the values contained in it must uniquely identify that particular row. That is you cannot have duplicate primary keys. This can be an advantage which adding rows to the table as you will not be allowed to add the same row (or  a row with the same primary key) twice.</p>
<p>The primary key column for a table is usually of type Integer although you could have Text. For example if you had a table of car information, then the &quot;Reg_No&quot; column could be made the primary key as it can be used to uniquely identify a particular row in the table.</p>
<p>A table doesn&apos;t have to have a primary key although they are recommended for larger tables. A primary key can also be made up of more than one column, although this is less ususal.</p>
<h2 class="mume-header" id="what-different-types-of-keys-are-there">What different types of keys are there?</h2>

<p>In addition to the primary key, a table may have one or more <em>Foreign keys</em>. A foreign key does not have to be unique or identified as a foreign key when the table is created. A foreign key in one table will relate to the primary key in another table. This allows a relationship to be created between the two tables. If a table needs to be related to several other tables, then there will be a foreign key  (column) for each of those tables.</p>
<h2 class="mume-header" id="how-does-the-database-represent-missing-data">How does the database represent missing data?</h2>

<p>All relational database systems have the concept of a NULL value. NULL can be thought of as being of all data types or of no data type at all. It represents something which is simply <em>not known</em>.</p>
<p>When you create a database table, for each column you are allowed to indicate whether or not it can contain the NULL value. Like primary keys, this can be used as a form of data validation.</p>
<p>In many real life situations you will have to accept that the data isn&apos;t perfect and will have to allow for NULL or missing values in your table.</p>
<p>In DB Browser we can indicate how we want NULL values to be displayed. We will use a RED background to the cell to make it stand out. In SQL queries you can specifically test for NULL values.</p>
<p>We will look at missing data in more detail in a later episode.</p>
<h2 class="mume-header" id="launching-db-browser">Launching DB Browser</h2>

<p>In Windows the installation of DB Browser does not create a desktop icon. To explicitly launch the application after installing it, use the windows button (bottom left of screen) and type in &#x2018;DB Browser&#x2019; in the search bar and selecting the application when it appears.</p>
<p><img src="./fig/DB_Browser_install_2.png" alt="DB Browser run"></p>
<h2 class="mume-header" id="the-initial-screen">The Initial screen</h2>

<p>The initial screen of DB Browser will look something like this, the panes may be in a different configuration;</p>
<p><img src="./fig/DB_Browser_run_1.png" alt="DB Browser initial screen"></p>
<p>There is;</p>
<p>A small menu system consisting of File, Edit, View and Help.<br>
Below the menu system is a toolbar with four options; New Database, Open Database, Write Changes and Revert Changes.</p>
<p>Below the toolbar is a 4-tabbed pane for; Database Structure, Browse Data, Edit Pragmas and Execute SQL. Initially these will be quite empty as we haven&apos;t created or opened a database yet. In general we will see how each of these are used as we go through the lesson with the exception of the Edit Pragmas tab which deals with system wide parameters which we won&apos;t want to change.</p>
<p>On the right hand side there are two further panes, at the top is the Edit Database Cell pane which is grayed out. Below it is a 3-tabbed pane for DB Schema, SQL log and Remote. We are only really interested in the DB Schema tab.</p>
<h2 class="mume-header" id="initial-changes-to-the-layout">Initial changes to the layout.</h2>

<p>The overall layout of DB Browser is quite flexible. The panes on the right-hand side can be dragged and dropped into any position, the individual tabs on the bottom pane closed directly from the pane and re-opened from the menu View item.</p>
<p>We will make a couple of initial changes to the layout of the screen. These will be retained across sessions.</p>
<ol>
<li>From the View menu item un-select the &apos;Edit Database Cell&apos; icon to the left of the text. This will make the pane close and the bottom pane will be expanded automatically to fill the space.</li>
<li>a) On Windows, From the View menu item select &apos;preferences&apos; and select the Data Browser tab.</li>
<li>b) On Mac, From the &quot;DB Browser for SQLite&quot; menu item select &apos;preferences&apos; and select the Data Browser tab.</li>
</ol>
<p><img src="./fig/DB_Browser_run_2.png" alt="Data Browser Preferences"></p>
<p>Towards the bottom there is a section dealing with Field colors. You will see three bars below the word Text, to the right there are in fact three invisible bars for the Background. Click in the area for the Background color for NULL. A colour selector window will open, select Red. The bar will turn Red. This is now the default background cell colour that will be used to display NULL values in you tables. We will discuss the meaning of NULL values in a table in a later episode.</p>
<p>You can now close the preference window by clicking OK.</p>
<h2 class="mume-header" id="opening-a-database">Opening a database</h2>

<p>For this lesson we will be making extensive use of the SQL_SAFI database. If you do not already have a copy of this database you can download it from <a href="./data/SQL_SAFI.sqlite">here</a>.</p>
<p>To open the database in DB Browser do the following;</p>
<ol>
<li>Click on the &apos;open database&apos; button in the toolbar.</li>
<li>Navigate to where you have stored the database file on your local machine, select it and click open.</li>
</ol>
<p>When you open the database, the &apos;Database Structure&apos; tab on the left and the &apos;DB Schema&apos; pane on the right will look very similar.</p>
<p>A Schema in its simplest form is a description of the table, in terms of column names and data types of the columns.</p>
<p>However the &apos;DB Schema&apos; pane is only there to allow you to see the details of the schema for the tables. In particular what tables are in the database and the fields and their types which are in each table.</p>
<p>The &apos;Database Structure&apos; tab on the left allows you to initiate actions on the tables.<br>
If you right click on a table name in the &apos;DB Schema&apos; pane, nothing happens.<br>
However, if you do the same in the &apos;Database Structure&apos; menu you will be given a set of possible actions.<br>
These are the same actions that are available from the toolbar at the top of the tab.</p>
<p><img src="./fig/DB_Browser_run_3.png" alt="Table Actions"></p>
<p>If you select &apos;Browse Table&apos;, the data from the table is loaded into the &apos;Browse Data&apos; pane from where it can be examined or filtered.<br>
You can also select the table you wish to Browse directly from here.</p>
<p>There are options for &apos;New Record&apos; and &apos;Delete Record&apos;. As our interest is in analysing existing data not creating or deleting data, it is unlikely that you will want to use these options.</p>
<h2 class="mume-header" id="running-sql-queries">Running SQL Queries</h2>

<p>We will be running queries extensively in future episodes. For now we will just provide an outline of the environment.</p>
<p>In the left hand pane if you select the Execute SQL tab, you will be presented with a three paned window and a small toolbar.<br>
The top pane is itself tabbed with the initial tab labeled &apos;SQL 1&apos;. This is the SQL editor pane into which you will type your queries.</p>
<p>Below is a simple example query and the results.</p>
<p><img src="./fig/DB_Browser_run_4.png" alt="SQL Query results"></p>
<p>Notice that the query has been written over multiple lines. This is commonly done to aid readability.<br>
The second pane has the tabular results, and the bottom pane has a message indicating how many rows were returned, how long it took and a copy of the SQL statement that was executed.</p>
<p>On the toolbar at the top there are eight buttons. Left to right they are:</p>
<ul>
<li>Open Tab        (creates a new tab in the editor)</li>
<li>Open SQL file   (allows you to load a prepared file of SQL into the editor - the tab takes the name of he file)</li>
<li>Save SQL file   (allows you to save the current contents of the active pane to the local file system)</li>
<li>Execute SQL     (Executes all of the SQL statements in the editor pane)</li>
<li>Execute current line    (Actually executes whatever is selected)</li>
<li>Save Results    (Either to a CSV file or as a database view. We will look at views in a later episode)</li>
<li>Find            (Text in the editor window)</li>
<li>Find &amp; Replace  (Text in the editor window)</li>
</ul>
<p>Because it is possible to have and execute multiple SQL statements in the same editor pane, each must be terminated with a &apos;;&apos;.<br>
If you only have a single statement you don&apos;t need it, but it might be considered best practice to always include it.</p>
<p>The pane below the editor is the Results pane. The results of running your query will appear here in a simple tabular format.<br>
The bottom pane is for messages about the execution, either an error message or an indication of how many rows were returned by the query.</p>
<h2 class="mume-header" id="creating-a-database">Creating a database</h2>

<p>As well as opening (connecting) to existing databases it is also possible to create new SQLite databases and tables using DB Browser.<br>
To create a database click the New Database button from the main toolbar (also available from the File menu). You will initially be asked for a name for the database and where you want to save it. It is saved as a single file. You can choose your own extension but &apos;sqlite&apos; is recommended. If you do not provide an extension, then a &apos;.db&apos; extension will be used. Although the new database is empty, in that there are no tables in it, the <code>.sqlite</code> file itself is not empty.</p>
<p>Once you have saved the database file the Create Table wizard will open allowing you to create a table. You can cancel this as we will be going through the create table process in a later episode.</p>
<h2 class="mume-header" id="write-changes-revert-changes">Write Changes &amp; Revert Changes</h2>

<p>Much of our SQL work involves looking at existing data using SQL queries and possibly writing out the results to a CSV file, in general we will not be changing the contents of the database.</p>
<p>However if, during your DB Browser session, you were to create or delete a table or create a view (discussed later), then the changes are not automatically written to the database file.</p>
<p>When you try to end the session (i.e. close the application) in which you have made such changes, then you will be asked if you want to save the changes you have made.</p>
<p>Alternatively you can explicitly save changes or revert changes during a session by use of the Write Changes and Revert Changes buttons on the toolbar.</p>
<p>Once written the changes are permanent (there is no concept of multiple &apos;undo&apos; like you might have in other programs).<br>
Revert Changes will take you back to the last Written copy.</p>
<h1 class="mume-header" id="the-select-statement">The select statement</h1>

<h2 class="mume-header" id="definition-of-sql">Definition of SQL</h2>

<p>SQL or Structured Query Language is an international standard for manipulating data in a relational database.</p>
<p>Each Relational Database system like Oracle, MySQL or SQLite implements its own variation of the standard.</p>
<p>Fortunately for the types of commands and queries that we will want to write, all of the implementations are much in agreement.<br>
The SELECT queries we will be writing to access data in our SQLite database will execute un-altered in many of the other environments.</p>
<p>Essentially you only have to learn SQL once.</p>
<h2 class="mume-header" id="sql-and-relational-database-tables">SQL and Relational database tables</h2>

<p>The strength of SQL is that a single SQL statement or query can request data be returned from one or many of the tables in the database.<br>
You can essentially define the relationships between tables on-the-fly as part of your query statement. Relationships between tables are often included as part of the overall database design. In our situation we may be getting an assortment of tables from different sources so being able to imply the relationship as part of the query has definite advantages.</p>
<h2 class="mume-header" id="ddl-and-dml">DDL and DML</h2>

<p>DDL stands for Data Definition Language. It is the set of SQL commands used to create alter of delete database objects such as tables.</p>
<p>DML stands for Data Manipulation Language. For our purposes this is the SELECT command which is used to extract data items from one or more of the database tables.</p>
<h2 class="mume-header" id="simple-sql-queries-using-the-select-statement">Simple SQL queries using the Select statement</h2>

<p>For the rest of this episode we will be looking at the SELECT statement.</p>
<p>To follow along, you should open the DB Browser application and connect to the SQL_SAFI database.</p>
<p>In SQL, querying data is performed by a SELECT statement. A select statement has 6 key components;</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> colnames
<span class="token keyword">FROM</span> tablename
<span class="token keyword">WHERE</span> conditions
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> colnames
<span class="token keyword">HAVING</span> conditions
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> colnames
</pre><p>In practice very few queries will have all of these clauses in them simplifying many queries. On the other hand, conditions in the WHERE clause can be arbitrarily complex and if you need to JOIN two or more tables together then more clauses (JOIN and ON) are needed.</p>
<p>All of the clause names above have been written in uppercase for clarity. SQL is not case sensitive. Neither do you need to write each clause on a new line, but it is often clearer to do so for all but the simplest of queries.</p>
<p>In this episode we will start with the very simple and work our way up to the more complex.</p>
<p>The simplest query is effectively one which returns the contents of the whole table</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> Farms<span class="token punctuation">;</span>
</pre><p>It is better practice and generally more efficient to explicitly list the column names that you want returned.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Country<span class="token punctuation">,</span> A06_province<span class="token punctuation">,</span> A07_district<span class="token punctuation">,</span> A08_ward<span class="token punctuation">,</span> A09_village
<span class="token keyword">FROM</span> Farms<span class="token punctuation">;</span>
</pre><p>The &apos;*&apos; character acts as a wildcard meaning all of the columns but you cannot use it as a general wildcard.</p>
<p>So for example, the following is not valid.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> A<span class="token operator">*</span>
<span class="token keyword">FROM</span> Farms<span class="token punctuation">;</span>
</pre><p>If you run it you will get an error.<br>
When an error does occur you will see an error message displayed in the bottom pane.</p>
<p>In addition to limiting the columns returned by a query, you can also limit the rows returned. The simplest case is to say how many rows are wanted using the <code>Limit</code> clause. In the example below only the first ten rows of the result of the query will be returned. This is useful if you just want to get a feel for what the data looks like.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> Farms
<span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
</pre><blockquote>
<h3>Exercise</h3>
<p>Write a query which returns the first 5 rows from the Farms table with only the columns Id, and B16 to B20.</p>
</blockquote>
<details><summary><b>Solution</b>  - click me</summary>
<h3>Solution</h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span>  Id
    <span class="token punctuation">,</span> B16_years_liv
    <span class="token punctuation">,</span> B17_parents_liv
    <span class="token punctuation">,</span> B18_sp_parents_liv
    <span class="token punctuation">,</span> B19_grand_liv
    <span class="token punctuation">,</span> B20_sp_grand_liv
<span class="token keyword">FROM</span> Farms
<span class="token keyword">LIMIT</span> <span class="token number">5</span><span class="token punctuation">;</span>
</pre><p>Because the query uses several columns (with longish names), for readability they have been set out on separate lines. SQL takes of white space to you are free to arrange the text of the query as you like.</p>
</details>
<br>
<h2 class="mume-header" id="the-where-clause">The <code>Where</code> clause</h2>

<p>Usually you will want to restrict the rows returned based on some criteria. i.e. certain values or ranges within one or more columns.</p>
<p>In this example we are only interested in rows where the value in the B16_years_liv column is greater than 25</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span>  Id<span class="token punctuation">,</span> B16_years_liv
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> B16_years_liv <span class="token operator">&gt;</span> <span class="token number">25</span>
<span class="token punctuation">;</span>
</pre><p>In addition to using the &apos;&gt;&apos; we can use many other operators such as &lt;, &lt;=, =, &gt;=, &lt;&gt;</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span>  Id<span class="token punctuation">,</span> B17_parents_liv
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> B17_parents_liv <span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span>
<span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="using-more-complex-logical-expressions-in-the-where-clause">Using more complex logical expressions in the <code>Where</code> clause</h2>

<p>We can also use the <code>AND</code> and <code>OR</code> keywords to build more complex selection criteria.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span>  Id
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span>    B17_parents_liv <span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span> 
     <span class="token operator">AND</span> B18_sp_parents_liv <span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span> 
     <span class="token operator">AND</span> B19_grand_liv <span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span> 
     <span class="token operator">AND</span> B20_sp_grand_liv <span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span> 
<span class="token punctuation">;</span>
</pre><p>Notice that the columns being used in the <code>WHERE</code> clause do not need to returned as part of the <code>SELECT</code> clause.</p>
<p>You can ensure the precedence of the operators by using brackets. Judicious use of brackets can also aid readability</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span>  Id
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>B17_parents_liv <span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span> <span class="token operator">OR</span> B18_sp_parents_liv <span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span><span class="token punctuation">)</span> <span class="token operator">AND</span> B16_years_liv <span class="token operator">&gt;</span> <span class="token number">60</span>
<span class="token punctuation">;</span>
</pre><blockquote>
<h3>Exercise</h3>
<p>From the above query, breakdown the <code>Where</code> clause so that each component can be tested individually.<br>
Make a note of how many rows are returned in each case.</p>
</blockquote>
<details><summary><b>Solution</b>  - click me</summary>
<h3>Solution</h3>
<p>To test each of the <code>or</code> clauses</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span>  Id
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> B17_parents_liv <span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span>
<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span>  Id
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> B18_sp_parents_liv <span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span>
<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span>  Id
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>B17_parents_liv <span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span> <span class="token operator">OR</span> B18_sp_parents_liv <span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span><span class="token punctuation">)</span> 
<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span>  Id
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> B16_years_liv <span class="token operator">&gt;</span> <span class="token number">60</span>
<span class="token punctuation">;</span>
</pre><p><code>OR</code> generally creates a less restrictive condition and <code>AND</code> makes a more restrictive condition.</p>
</details>
<br>
<p>The following query returns the rows where the value of B16_years_liv is in the range 51 to 59 inclusive.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> B16_years_liv
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> B16_years_liv <span class="token operator">&gt;</span> <span class="token number">50</span> <span class="token operator">AND</span> B16_years_liv <span class="token operator">&lt;</span> <span class="token number">60</span>
<span class="token punctuation">;</span>
</pre><p>The same results could be obtained by using the BETWEEN or IN operators</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> B16_years_liv
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> B16_years_liv <span class="token operator">BETWEEN</span> <span class="token number">51</span> <span class="token operator">AND</span> <span class="token number">59</span>
<span class="token punctuation">;</span>
</pre><pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> B16_years_liv
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> B16_years_liv <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">,</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>
<span class="token punctuation">;</span>
</pre><p>The list of values in brackets do not have to be contiguous or even in order.</p>
<blockquote>
<h3>Exercise</h3>
<p>Write a query using the Farms table which returns the columns <code>Id</code>, <code>A09_village</code>, <code>A11_years_farm</code>, <code>B16_years_liv</code>. We are only interested in rows where the <code>A09_village</code> value is either &apos;God&apos; or &apos;Ruaca&apos;. Additionally we only want <code>A11_years_farm</code> values in the range 20 to 30 exclusive and <code>B16_years_liv</code> values strictly greater than 40. There are many ways of doing this, but try to use an inequality, an <code>IN</code> clause and a <code>BETWEEN</code> clause.</p>
</blockquote>
<details><summary><b>Solution</b>  - click me</summary>
<h3>Solution</h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> A09_village<span class="token punctuation">,</span> A11_years_farm<span class="token punctuation">,</span> B16_years_liv
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span>     A09_village <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">&apos;God&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;Ruaca&apos;</span><span class="token punctuation">)</span> 
      <span class="token operator">AND</span> A11_years_farm <span class="token operator">BETWEEN</span> <span class="token number">21</span> <span class="token operator">AND</span> <span class="token number">29</span> 
      <span class="token operator">AND</span> B16_years_liv <span class="token operator">&gt;</span> <span class="token number">40</span>
<span class="token punctuation">;</span>
</pre></details>
<br>
<h2 class="mume-header" id="sorting-results">Sorting results</h2>

<p>If you want the results of your query to appear in a specific order, you can use the ORDER BY clause</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> A09_village<span class="token punctuation">,</span> A11_years_farm<span class="token punctuation">,</span> B16_years_liv
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> A09_village <span class="token operator">=</span> <span class="token string">&apos;God&apos;</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> A11_years_farm
<span class="token punctuation">;</span>
</pre><p>By default the SQL assumes Ascending order. You can make this more explicit by using the <code>ASC</code> or <code>DESC</code> keywords.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> A09_village<span class="token punctuation">,</span> A11_years_farm<span class="token punctuation">,</span> B16_years_liv
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> A09_village <span class="token operator">=</span> <span class="token string">&apos;God&apos;</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> A11_years_farm <span class="token keyword">DESC</span>
<span class="token punctuation">;</span>
</pre><p>You can also order by multiple columns</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> A09_village<span class="token punctuation">,</span> A11_years_farm<span class="token punctuation">,</span> B16_years_liv
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> A09_village <span class="token operator">=</span> <span class="token string">&apos;God&apos;</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> A11_years_farm <span class="token keyword">DESC</span> <span class="token punctuation">,</span> B16_years_liv <span class="token keyword">ASC</span>
<span class="token punctuation">;</span>
</pre><h1 class="mume-header" id="missing-data">Missing data</h1>

<h2 class="mume-header" id="how-does-the-database-represents-missing-data">How does the database represents missing data</h2>

<p>At the beginning of this lesson we noted that all database systems have the concept of a NULL value; Something which is missing and nothing is known about it.</p>
<p>In DB Browser we can choose how we want NULLs in a table to be displayed. When we had our initial look at DB Browser,<br>
we used the <code>View | Preference</code> option to change the background colour of cells in a table which has a <code>NULL</code> values as  <strong>red</strong>.<br>
The example below, using the &apos;Browse data&apos; tab,  shows a section of the Farms table in the SQL_SAFI database showing column values which are <code>NULL</code>.</p>
<p><img src="./fig/SQL_04_Nulls_01.png" alt="Farms NULLs"></p>
<p>If you type &apos;=NULL&apos; in the filter box for <code>F14_items_owned</code>, only the rows with NULL in <code>F14_items_owned</code> will be displayed.</p>
<p>You can get the same results using the following query;</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> Farms
<span class="token keyword">WHERE</span> F14_items_owned <span class="token operator">IS</span> <span class="token boolean">NULL</span>
<span class="token punctuation">;</span>
</pre><p>Notice that we use <code>IS</code> and not <code>=</code>. This is because &apos;NULL&apos; equals nothing and everything all at the same time!</p>
<p>This table was created from a csv file, part of which looks like this</p>
<p><img src="./fig/SQL_04_Nulls_02.png" alt="Farms_csv"></p>
<p>The highlighted area shows part of the record with Id = 21, the second record returned by the query. It starts with the &apos;F10_liv_owned&apos; column and ends with the &apos;G01_no_meals&apos; column. The Arrow points to the two consecutive &apos;,&apos;s representing the lack of a value for the &apos;F14_items_owned&apos; column. These values are missing from the data.</p>
<h2 class="mume-header" id="reasons-for-missing-data">Reasons for Missing data</h2>

<p>There can be many reasons why data is missing; Not collected, lost, Not applicable etc.<br>
In the case of our Farms table, many of the missing values have occurred as a result of the survey design.</p>
<p>If you run the following query :</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> E01_water_use<span class="token punctuation">,</span> E_no_group_count<span class="token punctuation">,</span> E_yes_group_count
<span class="token keyword">FROM</span> Farms
<span class="token punctuation">;</span>
</pre><p>The first part of the results will look like this:</p>
<p><img src="./fig/SQL_04_Nulls_04.png" alt="Farms_csv"></p>
<p>You may be able to spot from this the relationship between the values in the <code>E01_water_use</code> column and whether or not there is a <code>NULL</code> value in either the <code>E_no_group_count</code> or the <code>E_yes_group_count</code> column.</p>
<p>Only if the Farmer said that they did use water (E01_water_use = &apos;yes&apos;) they were asked how many plots they used water on and the value stored in E_yes_group_count otherwise this field was not even presented in the survey and so contains a <code>NULL</code> value. In this situation we expect <code>NULL</code> values and they will not cause any problems.</p>
<p>However the <code>F14_items_owned</code> column records the possessions of the Farmer. This question was always asked. It is not clear from the <code>NULL</code> values we find in this field whether or not it means &apos;I have no possessions&apos; or &apos;I do not wish to tell you what possessions I have&apos;, in short, we know nothing about the items owned and therefore the value of <code>NULL</code> is appropriate.</p>
<h2 class="mume-header" id="dealing-with-missing-data">Dealing with missing data</h2>

<p>There are several statistical techniques that can be used to allow for <code>NULL</code> values, which one you might will depend on what has caused the <code>NULL</code> value to be recorded.</p>
<p>You may want to change the <code>NULL</code> value to something else. For example if we knew that the <code>NULL</code> values in the <code>F14_items_owned</code> column actually meant that the Farmer had no possessions then we might want to change the <code>NULL</code> values to &apos;[]&apos; to represent and empty list. We can do that in SQL with an <code>UPDATE</code> query.</p>
<p>The update query is shown below. We are not going to run it as it would change our data.<br>
You need to be very sure of the effect you are going to have before you change data in this way.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">UPDATE</span> Farms
<span class="token keyword">SET</span> F14_items_owned <span class="token operator">=</span> <span class="token string">&apos;[]&apos;</span>
<span class="token keyword">WHERE</span> F14_items_owned <span class="token operator">is</span> <span class="token boolean">NULL</span> 
<span class="token punctuation">;</span>
</pre><p>Rather than changing the data we may just want to miss it out of our analysis.</p>
<p>We can write a query which excludes the rows where <code>F14_items_owned</code> has a `NULL value with:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> Farms
<span class="token keyword">WHERE</span> F14_items_owned <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">;</span>
</pre><h1 class="mume-header" id="creating-new-columns">Creating New Columns</h1>

<h2 class="mume-header" id="creating-new-columns-1">Creating new columns</h2>

<p>In addition to selecting existing columns from a table, you can also create new columns in the query output based on the existing columns. These new columns only exist in the output. The table used in the query is not changed in any way.</p>
<p>The Plots table contains a column, <code>D02_total_plot</code> representing the area of the plot and the <code>D03_unit_land</code> column gives the units. In our sample dataset the unit is always &apos;hectare&apos;. However in the full dataset some of the plot areas are recorded in &apos;acres&apos;. We want to create a new output column which shows the hectare value converted into acres. To do this we could use the following SQL. ( 1 hectare = 2.4701 acres)</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> D02_total_plot <span class="token operator">*</span> <span class="token number">2.4701</span>
<span class="token keyword">FROM</span> Plots
<span class="token punctuation">;</span>
</pre><p>Running this query will give the correct answers, but it uses the expression used in creating the new column as the column name.<br>
This looks very messy, especially if the expression is long.<br>
It is always the case that if you create a column in the results of the query it won&apos;t have a name by default.<br>
SQL will create one for it. Other relational databases take different approaches to the problem and will pseudo-randomly name the new columns for you with such things as &apos;_c0&apos;.<br>
SQLite uses the expression you used to create the column name.</p>
<h2 class="mume-header" id="renaming-columns-using-alias">Renaming columns using alias&apos;</h2>

<p>Given that creating new columns is so commonly done, SQL does provide a mechansim for giving them names of your choice. This is done using the <strong>AS</strong> clause</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> D02_total_plot <span class="token operator">*</span> <span class="token number">2.4701</span> <span class="token keyword">AS</span> D02_total_plot_converted
<span class="token keyword">FROM</span> Plots
<span class="token punctuation">;</span>
</pre><p>The <code>AS</code> keyword itself is optional. You can just put the name of the new column, but using the <code>AS</code> keyword adds clarity. Creating column names in this way is referred to as adding an alias.</p>
<p>This may seem a bit strange for columns which had no real name in the first place, but the point is, you can give any table column name an alias to be used in the output rather than the original.</p>
<h2 class="mume-header" id="using-built-in-functions-to-create-new-values">Using built-in functions to create new values</h2>

<p>In addition to using simple arithmetic operations to create new columns, you can also use some of the SQLite builtin functions.<br>
Full details of the available builtin functions are available from the <a href="https://sqlite.org/lang_corefunc.html#instr">SQLite.org</a> website.</p>
<p>We will look at some of the arithmetic and statistical functions when we deal with aggregations in a later lesson.</p>
<p>You may have noticed in the output from are last query that the number of decimal places can change from one row to another. In order to make the output more tidy, we may wish to always produce the same number of decimal places , e.g. 2. We can do this using the <code>ROUND</code> function.</p>
<p>The <code>ROUND</code> function works in a similar way as its spreadsheet equivalent, you specify the value you wish to round and the required number of decimal places.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>D02_total_plot <span class="token operator">*</span> <span class="token number">2.4701</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> D02_total_plot_converted
<span class="token keyword">FROM</span> Plots
<span class="token punctuation">;</span>
</pre><blockquote>
<h3>Exercise</h3>
<p>Write an SQL query which returns the Id, plot_Id, D01_curr_plot and D02_total_plot columns from the Plots table with the addition of a calculated column  representing the plot area in acres and a column representing the units of the calculated column.</p>
</blockquote>
<details><summary><b>Solution</b>  - click me</summary>
<h3>Solution</h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> plot_Id<span class="token punctuation">,</span> D01_curr_plot<span class="token punctuation">,</span> D02_total_plot<span class="token punctuation">,</span>
       <span class="token function">ROUND</span><span class="token punctuation">(</span>D02_total_plot <span class="token operator">*</span> <span class="token number">2.4701</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> D02_total_plot_converted<span class="token punctuation">,</span>
       <span class="token string">&apos;acres&apos;</span> <span class="token keyword">AS</span> D03_unit_land_converted
<span class="token keyword">FROM</span> Plots
<span class="token punctuation">;</span>
</pre><p>Notice that we can use columns as part of the calculated column which are not returned in the output.</p>
<p>Also our second new column doesn&apos;t actually need to make use of any of the other columns, it can just be a value.</p>
</details>
<br>
<p>SQLite has several string manipulation functions, many of which have equivalents in other programming languages or spreadsheet systems, sometimes with different names.</p>
<table>
<thead>
<tr>
<th>SQLite function</th>
<th style="text-align:left">Excel equivalent</th>
</tr>
</thead>
<tbody>
<tr>
<td>substr(a,b,c)</td>
<td style="text-align:left">mid(a,b,c)</td>
</tr>
<tr>
<td>instr(a,b)</td>
<td style="text-align:left">find(a,b)</td>
</tr>
</tbody>
</table>
<p><code>instr</code> can be used to check if a character or string of characters occurs within another string.</p>
<p><code>substr</code> can be used to extract a portion of a string based on a starting position and the number of characters required.</p>
<h2 class="mume-header" id="using-dates">Using Dates</h2>

<p>In the Farms table, the three columns  A01_interview_date, A04_start and A05_end are all recognisable as a dates with the A04_srtart and A05_end also including times. These last two are automatically generated by the eSurvey software when the data is collected. I.e. they are automatically entered. The 01_interview_date however is manually input. In all three cases however SQLite thinks that they are all just strings of characters. We can confirm this by selecting the <code>Database Structure</code> tab and expanding the <code>Farms</code> entry and notice that the data type for all three columns is listed as &apos;TEXT&apos;</p>
<p>To see what these columns look like you can run the following query;</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> A01_interview_date<span class="token punctuation">,</span> A04_start<span class="token punctuation">,</span> A05_end
<span class="token keyword">FROM</span> Farms
<span class="token punctuation">;</span>
</pre><p>The format of the A04_start and A05_end columns follow the <a href="https://www.w3.org/TR/NOTE-datetime">ISO-8601</a> stardard for representing dates and times. The A01_interview_date column on the other hand uses the shorthand dd/mm/yyyy format.</p>
<p>The drawback of having dates represented by strings occurs when you want to sort them.</p>
<p>In SQL you can sort the output of your query by using an <code>ORDER BY</code>clause at the end of the select statement as we have seen.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> A01_interview_date
<span class="token keyword">FROM</span> Farms
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> A01_interview_date
<span class="token punctuation">;</span>
</pre><p>NB. we are using the UK and European representation of dates in this dicussion. The same issue will occur if you were using US date formats</p>
<p>It is unlikely that the results of the above query is what you wanted. &apos;01/07/2017&apos; has been ordered before &apos;01/12/2016&apos;. This is because the sorting process treats the dates as simple strings and a &apos;0&apos; in the month position is less than a &apos;1&apos; in the month position.</p>
<p>In order to sort the A01_interview_date column into date order we need to make SQLite see it as a date. SQLite does have a date function. Unfortunately by itself, it won&apos;t work on A01_interview_date.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> A01_interview_date<span class="token punctuation">,</span> 
       <span class="token keyword">date</span><span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">)</span> <span class="token keyword">AS</span> converted_A01<span class="token punctuation">,</span>
       A04_start<span class="token punctuation">,</span>
       <span class="token keyword">date</span><span class="token punctuation">(</span>A04_start<span class="token punctuation">)</span> <span class="token keyword">AS</span> coverted_A04
<span class="token keyword">FROM</span> Farms
<span class="token punctuation">;</span>
</pre><p>Although it doesn&apos;t produce an error, the attempted conversion of A01_interview_date into a date format has failed. A set of NULLs was returned.</p>
<p><img src="./fig/SQL_05_dates_01.png" alt="Conversion failure"></p>
<p>On the otherhand the A04_start conversion did work. The problem is that the date function expects the string to be converted to be in a certain format.; like ISO-8601.</p>
<p>We need to change the way A01_interview_date looks. Instead of dd/mm/yyyy we need yyyy-mm-dd. To do this we can use the <code>substr</code> function along with the <code>||</code><br>
operator which is used to concatenate strings together.</p>
<p>We can extract individual parts of the date like this;</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> A01_interview_date<span class="token punctuation">,</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">year</span><span class="token punctuation">,</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">month</span><span class="token punctuation">,</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">day</span>
<span class="token keyword">FROM</span> Farms
<span class="token punctuation">;</span>
</pre><p>But in order to convert it into a date we need all three parts concatenated together along with &apos;-&apos; to seperate the parts</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> A01_interview_date<span class="token punctuation">,</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&apos;-&apos;</span> <span class="token operator">||</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&apos;-&apos;</span> <span class="token operator">||</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> converted_date
<span class="token keyword">FROM</span> Farms
<span class="token punctuation">;</span>
</pre><p>We can then convert our new string containing the date into a proper date by passing it to the <code>date</code> function.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> A01_interview_date<span class="token punctuation">,</span>
       <span class="token keyword">date</span><span class="token punctuation">(</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&apos;-&apos;</span> <span class="token operator">||</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&apos;-&apos;</span> <span class="token operator">||</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
       <span class="token punctuation">)</span> <span class="token keyword">as</span> converted_date
<span class="token keyword">FROM</span> Farms
<span class="token punctuation">;</span>
</pre><p>We can now use our <code>converted_date</code> column to sort by</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> A01_interview_date<span class="token punctuation">,</span>
       <span class="token keyword">date</span><span class="token punctuation">(</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&apos;-&apos;</span> <span class="token operator">||</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&apos;-&apos;</span> <span class="token operator">||</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
       <span class="token punctuation">)</span> <span class="token keyword">as</span> converted_date
<span class="token keyword">FROM</span> Farms
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> converted_date
<span class="token punctuation">;</span>
</pre><blockquote>
<h3>Exercise</h3>
<p>Change the query above to sort by the <code>A01_interview_date</code> field and compare the results</p>
</blockquote>
<details><summary><b>Solution</b>  - click me</summary>
<h3>Solution</h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> A01_interview_date<span class="token punctuation">,</span>
       <span class="token keyword">date</span><span class="token punctuation">(</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&apos;-&apos;</span> <span class="token operator">||</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&apos;-&apos;</span> <span class="token operator">||</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
       <span class="token punctuation">)</span> <span class="token keyword">as</span> converted_date
<span class="token keyword">FROM</span> Farms
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> A01_interview_date
<span class="token punctuation">;</span>
</pre></details>
<br>
<p>we started off by using the <code>substr</code> function to break out the day, month and year components of the date. There is merit in leaving the data in this format as it will still allow us to sort by the individual components.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> A01_interview_date<span class="token punctuation">,</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">year</span><span class="token punctuation">,</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">month</span><span class="token punctuation">,</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">day</span>
<span class="token keyword">FROM</span> Farms
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">year</span><span class="token punctuation">,</span> <span class="token keyword">month</span><span class="token punctuation">,</span> <span class="token keyword">day</span>
<span class="token punctuation">;</span>
</pre><p>By default the <code>ORDER BY</code> clause will sort in ascending order, smallest to biggist, we can make this explicit by usingthe <code>ASC</code> keyword. Or if we want to sort in descending order we can use the <code>DESC</code> keyword.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> A01_interview_date<span class="token punctuation">,</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">year</span><span class="token punctuation">,</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">month</span><span class="token punctuation">,</span>
       substr<span class="token punctuation">(</span>A01_interview_date<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">day</span>
<span class="token keyword">FROM</span> Farms
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">year</span> <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">month</span> <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">day</span> <span class="token keyword">DESC</span>
<span class="token punctuation">;</span>
</pre><p>Seperating dates into compnents like this make them universal. i.e. a dataset in this form can be written in any country&apos;s locale and then imported using a different country&apos;s locale without the possibility of confusion.</p>
<h2 class="mume-header" id="using-sql-syntax-to-conditionally-create-new-values">Using SQL syntax to conditionally create new values</h2>

<p>This format of the <code>case</code> statement allows you to check if various values <strong>are equal</strong> to the value in the field given after the <code>case</code> keyword.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> country<span class="token punctuation">,</span>
       <span class="token keyword">CASE</span> country
           <span class="token keyword">WHEN</span> <span class="token string">&apos;Moz&apos;</span> <span class="token keyword">THEN</span> <span class="token string">&apos;Mozambique&apos;</span>
           <span class="token keyword">WHEN</span> <span class="token string">&apos;Taz&apos;</span> <span class="token keyword">THEN</span> <span class="token string">&apos;Tanzania&apos;</span>
       <span class="token keyword">ELSE</span> <span class="token string">&apos;Unknown Country&apos;</span>
       <span class="token keyword">END</span> <span class="token keyword">AS</span> country_fullname
<span class="token keyword">FROM</span> Farms
<span class="token punctuation">;</span>
</pre><p>There is a more general form which allows us to perform any kind of test.</p>
<h2 class="mume-header" id="using-sql-syntax-to-create-binned-values">Using SQL syntax to create &#x2018;binned&#x2019; values</h2>

<p>It is often the case that we wish to convert a continous variable into a discrete factor type variable.</p>
<p>We can use a <code>case</code> statement to create this type of effect.</p>
<p>The column <code>A11_years_farm</code> in the Farms table is an indication of how many years the respondent has been on the farm. The values are in years and range from 1 tp 60.</p>
<p>Instead of using individual years we may want to group these values into ranges like 1-10, 11-20 etc. We can do this using a <code>case</code> statement as part of the <code>SELECT</code> clause.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> A11_years_farm<span class="token punctuation">,</span>
       <span class="token keyword">CASE</span>
           <span class="token keyword">WHEN</span>  A11_years_farm <span class="token operator">BETWEEN</span> <span class="token number">1</span> <span class="token operator">AND</span> <span class="token number">10</span> <span class="token keyword">THEN</span> <span class="token string">&apos;1-10&apos;</span>
           <span class="token keyword">WHEN</span>  A11_years_farm <span class="token operator">BETWEEN</span> <span class="token number">11</span> <span class="token operator">AND</span> <span class="token number">20</span> <span class="token keyword">THEN</span> <span class="token string">&apos;11-20&apos;</span>
           <span class="token keyword">WHEN</span>  A11_years_farm <span class="token operator">BETWEEN</span> <span class="token number">21</span> <span class="token operator">AND</span> <span class="token number">30</span> <span class="token keyword">THEN</span> <span class="token string">&apos;21-30&apos;</span>
           <span class="token keyword">WHEN</span>  A11_years_farm <span class="token operator">BETWEEN</span> <span class="token number">31</span> <span class="token operator">AND</span> <span class="token number">40</span> <span class="token keyword">THEN</span> <span class="token string">&apos;31-40&apos;</span>
           <span class="token keyword">WHEN</span>  A11_years_farm <span class="token operator">BETWEEN</span> <span class="token number">41</span> <span class="token operator">AND</span> <span class="token number">50</span> <span class="token keyword">THEN</span> <span class="token string">&apos;41-50&apos;</span>
           <span class="token keyword">WHEN</span>  A11_years_farm <span class="token operator">BETWEEN</span> <span class="token number">41</span> <span class="token operator">AND</span> <span class="token number">50</span> <span class="token keyword">THEN</span> <span class="token string">&apos;51-60&apos;</span>
       <span class="token keyword">ELSE</span> <span class="token string">&apos;&gt; 60&apos;</span>       
       <span class="token keyword">END</span> <span class="token keyword">AS</span> A11_years_farm_range
<span class="token keyword">FROM</span> Farms
<span class="token punctuation">;</span>
</pre><h1 class="mume-header" id="aggregations">Aggregations</h1>

<h2 class="mume-header" id="using-built-in-statistical-functions">Using built-in statistical functions</h2>

<p>Aggregate functions are used perform some kind of mathematical or statistical calculation across a group of rows. The rows in each group are determined<br>
by the different values in a specified column or columns.  Alternatively you can aggregate across the entire table.</p>
<p>If we wanted to know the minimum, average and maximum values of the &apos;A11_years_farm&apos; column across the whole Farms table, we could write a query such as this;</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> 
       <span class="token function">min</span><span class="token punctuation">(</span>A11_years_farm<span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token function">max</span><span class="token punctuation">(</span>A11_years_farm<span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token function">avg</span><span class="token punctuation">(</span>A11_years_farm<span class="token punctuation">)</span>
<span class="token keyword">from</span> Farms<span class="token punctuation">;</span> 
</pre><p>This sort of query provides us with a general view of the values for a particular column or field across the whole table.</p>
<p><code>min</code> , <code>max</code> and <code>avg</code> are builtin aggregate functions in SQLite (and any other SQL database system). There are other such functions available. A complete list can be found in the SQLite documentation <a href="https://sqlite.org/lang_aggfunc.html">here</a></p>
<p>It is more likely that we would want to find such values for a range, or multiple ranges of rows where each range is determined by the values of some other column in the table. Before we do this we will look at how we can find out what different values are contained in a given column.</p>
<h2 class="mume-header" id="the-distinct-keyword">The <code>Distinct</code> keyword</h2>

<p>For the SAFI survey, it was know in advance all of the possible values that certain variables of columns could contain. For example the &apos;A06_province&apos;, &apos;A07_district&apos;, &apos;A08_ward&apos; and &apos;A09_village&apos; variables could only ever contain a few specific values.</p>
<p>As the SAFI survey was delivered via an Android phone app. It was possible to create the app so that the possible values could be<br>
selected from a dropdown list, eliminating any possibility of typing errors. For the &apos;A06_province&apos; there were only three possibilities, but by the time we get down to &apos;A09_villages&apos;, a far more specific geography, it would not have been possible to anticipate in advance all of the possible values (village names)<br>
and so the values for this field were manually typed in.</p>
<p>To obtain a list of unique values in a particular column we can use the <code>Distinct</code> keyword.</p>
<p>Using the Farms table we will obtain a list of all of the different values of the &apos;A06_province&apos; column contained in the table.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> A06_province
<span class="token keyword">from</span> Farms<span class="token punctuation">;</span>
</pre><p>We can see from the results of running this that all 3 values are represented and that there is no missing data in this field.</p>
<p>However if we run a similar query for &apos;A09_village&apos;</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> A09_village
<span class="token keyword">from</span> Farms<span class="token punctuation">;</span>
</pre><p>We get</p>
<p><img src="./fig/SQL_06_villages.png" alt="Villages"></p>
<p>The problem with allowing free-form text is quite obvious. Having two villages, one called &apos;Massequece&apos; and the other called &apos;Massequese&apos; is unlikely.</p>
<p>Detecting this type of problem in a large dataset can be very difficult if you are just &apos;eyeballing&apos; the content. This small SQL query makes it very clear.</p>
<p>You can have more than one column name after the <code>Distinct</code> keyword. In which case the results will include a row for each unique <strong>combination</strong> of the columns involved</p>
<blockquote>
<h3>Exercise</h3>
<p>Write a query that will return all of the different combinations of the<br>
&apos;A06_province&apos;, &apos;A07_district&apos;, &apos;A08_ward&apos; and &apos;A09_village&apos; columns in the Farms table.</p>
<p>When looking at the results, you may have noticed that they are not in any sorted order. Re-write the query so that the values of the four columns<br>
are returned in alphabetical order.</p>
</blockquote>
<details><summary><b>Solution</b>  - click me</summary>
<h3>Solution</h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> A06_province<span class="token punctuation">,</span> A07_district<span class="token punctuation">,</span> A08_ward<span class="token punctuation">,</span> A09_village
<span class="token keyword">from</span> Farms
<span class="token keyword">order</span> <span class="token keyword">by</span> A06_province<span class="token punctuation">,</span> A07_district<span class="token punctuation">,</span> A08_ward<span class="token punctuation">,</span> A09_village<span class="token punctuation">;</span>

</pre></details>
<br>
<h2 class="mume-header" id="the-group-by-clause-to-summarise-data">The <code>group by</code> clause to summarise data</h2>

<p>Just knowing the combinations is of limited use. You really want to know <strong>How many</strong> of each of the values there are.<br>
To do this we use  the <code>GROUP BY</code> clause.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> A08_ward<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> How_many
<span class="token keyword">from</span> Farms
<span class="token keyword">group</span> <span class="token keyword">by</span> A08_ward<span class="token punctuation">;</span>
</pre><p>This query tells us how many records in the table have each different value in the &apos;A08_ward&apos; column.</p>
<p>In the first example of this episode, three aggregations were performed over the single column &apos;A11_years_farm&apos;. In addition to calculating multiple aggregation values over a single column, it is also possible to aggregate over multiple columns by specifying them in all in the <code>SELECT</code> clause <strong>and</strong> the <code>GROUP BY</code> clause.</p>
<p>The grouping will take place based on the order of the columns listed in the <code>GROUP BY</code> clause. There will be one row returned for each unique combination of the columns mentioned in the <code>GROUP BY</code> clause.</p>
<p>What is not allowed is specifying a non-aggregated column in the select clause which is not mentioned in the group by clause.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> A06_province<span class="token punctuation">,</span> 
       A07_district<span class="token punctuation">,</span>
       A08_ward<span class="token punctuation">,</span>
       A09_village<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> How_many
<span class="token keyword">from</span> Farms
<span class="token keyword">Group</span> <span class="token keyword">By</span> A06_province<span class="token punctuation">,</span> A07_district<span class="token punctuation">,</span> A08_ward<span class="token punctuation">,</span> A09_village
<span class="token punctuation">;</span>
</pre><blockquote>
<h3>Exercise</h3>
<p>Write a query which returns the min, max and avg values as well as a count of the number of records involved for the &apos;A11_years_farm&apos; column for each village in the &apos;Nhamatanda&apos; district.</p>
</blockquote>
<details><summary><b>Solution</b>  - click me</summary>
<h3>Solution</h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> A09_village<span class="token punctuation">,</span>
       <span class="token function">min</span><span class="token punctuation">(</span>A11_years_farm<span class="token punctuation">)</span> <span class="token keyword">as</span> min<span class="token punctuation">,</span>
       <span class="token function">max</span><span class="token punctuation">(</span>A11_years_farm<span class="token punctuation">)</span> <span class="token keyword">as</span> max<span class="token punctuation">,</span>
       <span class="token function">avg</span><span class="token punctuation">(</span>A11_years_farm<span class="token punctuation">)</span> <span class="token keyword">as</span> avg<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> how_many
<span class="token keyword">from</span> Farms
<span class="token keyword">where</span> A07_district <span class="token operator">=</span> <span class="token string">&apos;Nhamatanda&apos;</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> A09_village<span class="token punctuation">;</span>
</pre><p>Notice that you can use the &apos;A07_district&apos; column in the <code>where</code> clause but it doesn&apos;t have to appear in the <code>select</code> clause.</p>
</details>
<br>
<h2 class="mume-header" id="using-the-having-clause">Using the <code>having</code> clause</h2>

<p>In order to filter the rows returned in a non-aggregated query we used the <code>WHERE</code> clause. For an aggregated query the equivalent is the &apos;HAVING` clause.</p>
<p>You use the &apos;HAVING` clause by providing it with a filter expression which references one or more of the aggregated columns.</p>
<p>In a <code>HAVING</code> clause you can use the column alias to refer to the aggregated column.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> A08_ward<span class="token punctuation">,</span>
       <span class="token function">min</span><span class="token punctuation">(</span>A11_years_farm<span class="token punctuation">)</span> <span class="token keyword">as</span> min_years<span class="token punctuation">,</span>
       <span class="token function">max</span><span class="token punctuation">(</span>A11_years_farm<span class="token punctuation">)</span> <span class="token keyword">as</span> max_years<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> how_many_farms
<span class="token keyword">from</span> Farms
<span class="token keyword">group</span> <span class="token keyword">by</span> A08_ward
<span class="token keyword">having</span> how_many_farms <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
</pre><p>In this example we want to ignore the wards which only have one or two farms.</p>
<blockquote>
<h3>Exercise</h3>
<p>Using the Crops table write a query which will list all of the crops (D_curr_crop) which are grown in over 100 plots.</p>
</blockquote>
<details><summary><b>Solution</b>  - click me</summary>
<h3>Solution</h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> D_curr_crop<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> how_many
<span class="token keyword">from</span> Crops
<span class="token keyword">group</span> <span class="token keyword">by</span> D_curr_crop
<span class="token keyword">having</span> how_many <span class="token operator">&gt;</span> <span class="token number">100</span>
<span class="token punctuation">;</span>
</pre></details>
<br>
<h1 class="mume-header" id="creating-tables-and-views">Creating Tables and Views</h1>

<h2 class="mume-header" id="using-sql-code-to-create-tables">Using SQL code to create tables</h2>

<p>In relational databases, tables have to be created before you can add data to them.<br>
The table definition that you create is referred to as the <strong>Schema</strong> of the table.</p>
<p>The schema can contain many different properties of the table and the data that it does/will contain.<br>
In its simplest form you only need to specify a name for the table and a list of the column names and the data types for each of those columns.</p>
<p>Initially your data is likely to be external to the relational database system in a set of simple files.<br>
Typically in CSV (comma separated values) or Tab delimited format.</p>
<p>All relational database systems will have some utility which will allow you to import such files into tables in the database.<br>
The DB Browser application has a nice GUI (Graphical Use Interface) to allow you to do this. It appears to be a single step process, much like importing a file into Excel. In fact it is always a two step process.</p>
<p>The Farms, Plots and Crops tables that we have been using were created in the DB Browser application by importing a CSV<br>
file containing the data.</p>
<p>For large datasets this is a very common approach</p>
<h2 class="mume-header" id="using-the-db-browser-application-to-create-tables">Using the DB Browser application to create tables</h2>

<ol>
<li>
<p>From the File menu select Import and then &apos;Table from CSV file&apos;.<br>
This will start the &apos;Import CSV file&apos; wizard and you will be asked to select the file of data you wish to import from a standard Windows file open dialog.</p>
</li>
<li>
<p>After you have selected the file, you will be shown the &apos;Import CSV file&apos; window which will allow you to set a name for the table (the default is taken from the filename). You will see the first few rows of the data and there are  a few options which can be changed if needs be.</p>
</li>
</ol>
<p><img src="./fig/SQL_07_Import_wizard_01.png" alt="Import table"></p>
<p>In our case all of the options are correctly set. If your file was in Tab delimited format, you would need to change the &apos;Field separator&apos; option to &apos;Tab&apos;. If your file did not have a header row with column names you would un-check the appropriate box and DB Browser will allocate names for the columns. (You can change them to more meaningful names yourself after the import is complete)</p>
<ol start="3">
<li>When you click OK, a table will be created and the data loaded into the table. Unfortunately this Import wizard in DB Browser does not do, or allow you to do everything that you might want when creating a table. The most obvious potential problem is that we were not allowed to specify the data types to be associated with each of the columns in the table. However, DB Browser will attempt to work out the appropriate data types based on the values in the first few rows of the data. This is a very common approach.<br>
(Earlier versions of DB Browser didn&apos;t do this, it just imported all of the columns as &apos;Text&apos; data types.) If you go to the table in the Database Structure tab and click the &apos;&gt;&apos; you will see all of the fields and they are all listed as either Text or Integer fields.</li>
</ol>
<p>If any of the datatypes are not as expected or wanted we can change them.</p>
<ol start="4">
<li>Select the newly created table in Database Structure tab and click the &apos;Modify Table&apos; button in the toolbar. The &apos;Edit Table Definition&apos; dialog will appear.</li>
</ol>
<p><img src="./fig/SQL_07_Import_Wizard_02.png" alt="Modify Table"></p>
<p>In this particular case DB Browser correctly selected the datatypes. Notice that the <code>A01_interview_date</code> was allocated a datatype of &apos;TEXT&apos;. This isn&apos;t a problem as we have to use the Date and Time functions to manipulate dates anyway.</p>
<p>Notice that the bottom pane in the Window shows the SQL DDL statement that would create the table that you modifying.</p>
<p>When you change one of the columns from TEXT to INTEGER, this is immediately reflected in the Create Table statement.  It is slightly misleading because in fact we are modifying an existing table and in SQL-speak, this would be an <strong>Alter Table...</strong> statement. However it does illustrate quite well the fact that whatever you do in the GUI, it is essentially translated into an SQL statement and executed.</p>
<p>In addition to changing the data types there are several other options which can be set when you are creating of modifying a table.<br>
For our tables we don&apos;t need to make use of them but for completeness we will describe what they are;</p>
<p><strong>PK</strong> - Or Primary Key, a unique identifier for the row. In the Farms table, there is an <code>Id</code> column which uniquely identifies a Farm.<br>
This could  act as a unique identifier for the row as a whole. We could mark this as the primary key if we wanted to.</p>
<p><strong>AI</strong> - Or Auto Increment. This isn&apos;t really applicable to tables created in this way, i.e. the creation of the schema immediately followed by loading data from a file. It is usually used to generate unique values for a column which could then act as a primary key. If you have an &apos;Auto Increment&apos; column in a table, when you insert values you would not supply a value for the column  as SQLite will automatically provide a value for each row added.</p>
<p><strong>Not Null</strong> - If this is checked then it means that there must be a value for each row in this column. If it is <strong>not</strong> set and there is no value provided in the data then it will be set to &apos;NULL&apos; which means &apos;I know nothing about what should be here&apos;. (Not the string &apos;NULL&apos; but the NULL value)</p>
<p>In real datasets missing values are quite common and we have already looked at ways of dealing with them when they occur in tables. If you you were <strong>check</strong> this box and the data did have missing values for this column, the record from the file would be rejected and the load of the file will fail.</p>
<p><strong>U</strong> - Or Unique. This allows you to say that the contents of the column, which is not the primary key column has to have unique values in it. Like Allow Null this is another way of providing some data validation as the data is imported. Although it doesn&apos;t really apply with the DB Browser import wizard as the data is imported before you are allowed to set this option.</p>
<p><strong>Default</strong> - This is used in conjunction with &apos;Not Null&apos;, if a value is not provided in the dataset, then if provided, the default value for that column will be used.</p>
<p><strong>Check</strong> - This allows you to specify a constraint on the values entered for the column. You could restrict the range of values or compare the value with other columns values.</p>
<p>These three options, &apos;Not Null&apos;, &apos;Unique&apos; and &apos;Default&apos; , need to be used with caution and certainly their use needs to be fully documented and explained.</p>
<blockquote>
<h3>Exercise</h3>
<p>From the Modify table dialog, change the <code>Id</code> column in the <code>Farms</code> table to be the primary key. What difference did it make in the <code>CREATE TABLE</code> statement?</p>
</blockquote>
<details><summary><b>Solution</b>  - click me</summary>
<h3>Solution</h3>
<p>You need to scroll down to the bottom of the <code>CREATE TABLE</code> statement to see the</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql">     <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span><span class="token punctuation">`</span>Id<span class="token punctuation">`</span><span class="token punctuation">)</span>
</pre><p>line added</p>
</details>
<br>
<p>You could copy and paste this definition into the SQL editor and if you change the table name before you ran it, you would create a new table with that name. This new table would have no data in it. This is how the insert table wizard works. It uses the header row from your data to create a <code>CREATE TABLE</code> statement which it runs. It then transforms each of the rows of data into SQL <code>INSERT INTO...</code> statements which it also runs to get the data into the table. Hence the 2-step process.</p>
<p>Using <code>CREATE TABLE</code> and <code>INSERT INTO...</code> statements is only really practical for small tables. For larger tables directly loading into the database is the only practical approach, and most commonly from simple csv type files.</p>
<h2 class="mume-header" id="creating-tables-from-other-tables">Creating tables from other tables</h2>

<p>Whenever you write a Select query and run it, the results are always in the form of a table.<br>
In the results pane, you can see the column names and the rows of data in the results.</p>
<p>This provides a very easy way of creating a new table based on the results of a query.</p>
<p>The following query selects a few of the columns from the Farms table</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> 
       Country<span class="token punctuation">,</span> 
       A06_province<span class="token punctuation">,</span> 
       A07_district<span class="token punctuation">,</span>
       A08_ward<span class="token punctuation">,</span> 
       A09_village
<span class="token keyword">FROM</span> Farms<span class="token punctuation">;</span>
</pre><p>If you want to make the results of this query into a new table, you can do so by simply prefixing the <code>SELECT</code> with <strong>CREATE TABLE  NewTablename AS</strong>  like this</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> Farms_location <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> 
       Country<span class="token punctuation">,</span> 
       A06_province<span class="token punctuation">,</span> 
       A07_district<span class="token punctuation">,</span>
       A08_ward<span class="token punctuation">,</span> 
       A09_village
<span class="token keyword">FROM</span> Farms<span class="token punctuation">;</span>
</pre><p>If we wanted to create a table from the Crops table which contains only the rows where the D_curr_crop value was &apos;rice&apos; we could use a query like this:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> crops_rice <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> Crops
<span class="token keyword">WHERE</span> D_curr_crop <span class="token operator">=</span> <span class="token string">&apos;rice&apos;</span>
<span class="token punctuation">;</span>
</pre><p>Here we want all of the columns from the Crops table but only if the D_curr_crop value is &apos;rice&apos;.</p>
<p>Note: please ensure that you run the code above as we will use this new table in a later lesson.</p>
<h2 class="mume-header" id="using-sql-code-to-create-views">Using SQL code to create views</h2>

<p>In addition to tables all relational database systems have the concept of &apos;Views&apos;. Views are based on tables.<br>
In the same way that we were able to create a table based on a <code>SELECT</code> query, we can create a &apos;View&apos; in the same way. You just replace &apos;Table&apos; with &apos;View&apos;.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> Farms_location <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> 
       Country<span class="token punctuation">,</span> 
       A06_province<span class="token punctuation">,</span> 
       A07_district<span class="token punctuation">,</span>
       A08_ward<span class="token punctuation">,</span> 
       A09_village
<span class="token keyword">FROM</span> Farms<span class="token punctuation">;</span>
</pre><p>Tables and Views are so closely related that if you try to run the code above, although &apos;Table&apos; has been changed to &apos;View&apos; you will get an error complaining that the &apos;Table&apos; already exists.</p>
<p>It is common practice when creating Views to indicate somewhere in the name that it is in fact a View. e.g. vFarms_location or Farms_location_v.</p>
<p>Although tables and views can be used almost interchangeably in <code>Select</code> queries it is important to note that a <code>View</code> unlike a <code>Table</code> contains no data. It is essentially the SQL statement needed to produce that data from the underlying data. This means that when you use a View there is the overhead of having to run this SQL first. Although in practice the Database system will combine the SQL required by the View and the other SQL in your query so as to optimise how the SQL is executed.</p>
<p>The advantage of using Views is that it allows you to restrict how you see the data in a table. In the example we used above it may be far easier to work with only the 6 columns that we need from the full Farms table rather than the full table with 61 columns.</p>
<p>A View isn&apos;t restricted to simple <code>Select</code> statements it can be the result of aggregations and joins as well. This can help reduce the complexity of queries based on the View and so aid readability.</p>
<h1 class="mume-header" id="joins">Joins</h1>

<h2 class="mume-header" id="about-table-joins">About table joins</h2>

<p>In any relational database system, the ability to join tables together is a key querying requirement. Joins are used to combine the columns from two (or more) tables together to form a single table. A join between tables will only be possible if they have at least one column in common. The column doesn&apos;t have to have the same name in each table, and quite often they won&#x2019;t, but they do have to have a common usage.</p>
<p>In the SAFI database we have three tables. Farms, Plots and Crops. Each farm has a number of plots (or fields) and each plot can be used to grow different crops. A question you might ask is: Which Farms with more than 12 people in the household grow Maize? No single table has the answer to this question.</p>
<p>We can write queries to answer each part separately</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token comment">-- how many crops of Maize?</span>
<span class="token keyword">select</span> <span class="token operator">*</span> 
<span class="token keyword">from</span> Crops
<span class="token keyword">where</span> D_curr_crop <span class="token operator">=</span> <span class="token string">&apos;maize&apos;</span>
<span class="token punctuation">;</span>
</pre><p><img src="./fig/SQL_09_maize.png" alt="Maize"></p>
<p>and</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token comment">-- Which farms have more than 12 in the Household</span>
<span class="token keyword">select</span> Id<span class="token punctuation">,</span> B_no_membrs 
<span class="token keyword">from</span> Farms
<span class="token keyword">where</span> B_no_membrs <span class="token operator">&gt;</span> <span class="token number">12</span>
<span class="token punctuation">;</span>
</pre><p><img src="./fig/SQL_09_maize.png" alt="Maize"></p>
<p>In order to answer the question we need information from both tables at the time, i.e. from a single query. Notice that in the tables returned by both of the above queries we have the <code>Id</code> column. This column represents the Household or Farm in both of the tables. Because of this we can use this <code>Id</code> column from both tables to <code>join</code> the tables together.  Providing we are confident that both of the columns represent the household (or farm) it doesn&apos;t matter whether or not they have the same name.</p>
<p>We write a <code>join</code> query like this:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> a<span class="token punctuation">.</span>B_no_membrs<span class="token punctuation">,</span>
       b<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> b<span class="token punctuation">.</span>D_curr_crop
<span class="token keyword">from</span> Farms <span class="token keyword">as</span> a
<span class="token keyword">join</span> Crops <span class="token keyword">as</span> b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>Id <span class="token operator">=</span> b<span class="token punctuation">.</span>Id <span class="token operator">and</span> a<span class="token punctuation">.</span>B_no_membrs <span class="token operator">&gt;</span> <span class="token number">12</span> <span class="token operator">and</span> b<span class="token punctuation">.</span>D_curr_crop <span class="token operator">=</span> <span class="token string">&apos;maize&apos;</span>
<span class="token punctuation">;</span>
</pre><p>There are several things to notice about this query:</p>
<ol>
<li>We have used alias&apos; for the table names in the same way as we used with columns in a previous lesson. In this case though, it is not to provide more meaningful names, in fact alias&apos; for tables are often single letters to save key strokes.</li>
<li>We use the table alias as a prefix, plus a &apos;.&apos; when we refer to a column name from the table. You don&apos;t have to do this, but it generally adds clarity to the query.</li>
<li>You will need to use an alias when you need to refer to a column with the same name in both tables. In our case we need to compare the <code>Id</code> column in both tables.</li>
<li>In the select clause, we list all of the columns, from both table that we want in the output. We use the alias&apos; for clarity. If the column name is not ambiguous, i.e it only occurs in one of the tables it can be omitted, but as we have said it is better to leave it in for clarity.</li>
<li>The name of the second table is given in the <code>join</code> clause.</li>
<li>The conditions of the <code>join</code> are given in the <code>on</code> clause. The <code>on</code> clause is very much like a <code>where</code> clause, in that you specific expressions which restrict what rows are output. In our example we have three expressions. The last two are the individual expressions we used in the previous, single table queries. The first expression <code>a.Id = b.Id</code> is the expression which determines how we want the two tables to be joined. We are only interested in rows from both table where the <code>Id</code> values match.</li>
</ol>
<p>When we run this query we get output like the following:</p>
<p><img src="./fig/SQL_09_join1.png" alt="Join1"></p>
<blockquote>
<h3>Exercise</h3>
<ol>
<li>The output includes the <code>Id</code> column from both tables, how could you have distinguished between them when you wrote the query?</li>
<li>Can you explain why there are two rows for <code>Id</code> 111?  Can you change the query so that these two different rows are being correctly displayed?</li>
</ol>
</blockquote>
<details><summary><b>Solution</b>  - click me</summary>
<h3>Solution</h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>Id <span class="token keyword">as</span> Farms_Id<span class="token punctuation">,</span> a<span class="token punctuation">.</span>B_no_membrs<span class="token punctuation">,</span>
        b<span class="token punctuation">.</span>Id <span class="token keyword">as</span> Crops_Id<span class="token punctuation">,</span> b<span class="token punctuation">.</span>plot_Id<span class="token punctuation">,</span> b<span class="token punctuation">.</span>D_curr_crop
<span class="token keyword">from</span> Farms <span class="token keyword">as</span> a
 <span class="token keyword">join</span> Crops <span class="token keyword">as</span> b
 <span class="token keyword">on</span> a<span class="token punctuation">.</span>Id <span class="token operator">=</span> b<span class="token punctuation">.</span>Id <span class="token operator">and</span> a<span class="token punctuation">.</span>B_no_membrs <span class="token operator">&gt;</span> <span class="token number">12</span> <span class="token operator">and</span> b<span class="token punctuation">.</span>D_curr_crop <span class="token operator">=</span> <span class="token string">&apos;maize&apos;</span>
<span class="token punctuation">;</span>
</pre><ol>
<li>we can add alias&apos; to the two <code>Id</code> columns to distinguish them.</li>
<li>by adding the <code>plot_Id</code> column from the Crops table. It is clear that <code>Id</code> 111 has two plots (plot 1 and plot 2) growing maize.</li>
</ol>
</details>
<br>
<h2 class="mume-header" id="different-join-types">Different join types</h2>

<p>The example of a join given above is called an <strong>INNER</strong> join, we could have written <strong>INNER JOIN</strong> rather than simply <strong>JOIN</strong>. This is almost never done in practice as the inner join is by far the most common join type used.</p>
<p>Other Join types are available...</p>
<p>Before we look at the other join types we need to explain how the <strong>Inner join</strong> works and why it is so commonly used.</p>
<p>For any join (type) we are defining a relationship between two tables based on the data values in two columns, one from each table.<br>
The relationship is given by the criteria in the <code>ON</code> clause. The value of the column in one table must be same as that in the other table. That is; the criteria is given in the form <code>value_in_column_from_table_a = value_in_column_from_table_b</code>. Only if this criteria is TRUE will the requested columns from table_a and table_b be returned as a single row in the output. During the join process each row of the first with every row of the second and if a match is found then a row combining the columns from both tables is output.</p>
<p>Although typically the values being matched from the first table are a unique (Distinct) set of values, the values in the second table don&apos;t have to be unique. This is why in the results of our previous query there are two entries with Id 111. In the second table there are two records with Id 111 and so the record from the first table gets combined with both the records in the second table and two records are output.</p>
<p>Because every Farm grows some crops, there will be at least one record for each Id output. I for whatever reason the was a Farm with no crops then there would be no record output for that Farm Id. Similarly if there was an entry in the Crops table with an Id which didn&apos;t match any of the Ids in the Farms table, then it would not be output. There is only an output record when the two columns have matching values.</p>
<p>When a relational database is defined and the tables set up initially the relationship between the tables are already known,<br>
they are part of the design of the overall database. Because of this it is possible to ensure when the data is added to the tables that there will be entries in both tables which have matching values. At the very least you can prevent rows being added to the second table with a value in the column you intend to join on for which there is no matching column in the first table.</p>
<p>An inner join only returns rows where there is a match between the two columns. In most cases this will be all of the columns selected from the first table and 0,1 or more columns selected from the second table.</p>
<p>The relational design makes use of multiple tables as a way of avoiding repetition of data. Joining tables re-introduces the replication of the data.</p>
<h2 class="mume-header" id="there-are-several-different-join-types-possible">There are several different join types possible</h2>

<table>
<thead>
<tr>
<th>Join Type</th>
<th style="text-align:left">What it does</th>
</tr>
</thead>
<tbody>
<tr>
<td>Inner Join</td>
<td style="text-align:left">Matched rows in both tables are returned</td>
</tr>
<tr>
<td>Left outer join</td>
<td style="text-align:left">All row in the left hand table are returned along with the matches from the right hand table or NULLs if there is no match</td>
</tr>
<tr>
<td>Right outer join</td>
<td style="text-align:left">All row in the right hand table are returned along with the matches from the left hand table or NULLs if there is no match</td>
</tr>
<tr>
<td>Full outer join</td>
<td style="text-align:left">All rows from both tables are returned, with NULLs where there are no matches</td>
</tr>
<tr>
<td>Cross join</td>
<td style="text-align:left">Each row in the first table will be matched with every row in the second table. It is possible to imagine situations where this is required but in most cases it is a mistake and un-intended.</td>
</tr>
</tbody>
</table>
<p>In SQLite only the <code>Inner join</code>, the <code>Left Outer join</code> and the <code>Cross join</code> are supported. You can create a <code>Right outer join</code> by swapping the tables in the <code>From</code> and <code>Join</code> clauses. A <code>Full outer join</code> is the combination of the Left outer and Right outer joins.</p>
<h2 class="mume-header" id="using-different-join-types-in-analysing-your-data">Using different join types in analysing your data</h2>

<p>In many cases the data you have in your tables may have come from disparate sources, in that they do not form part of a <strong>planned</strong> relational database. It has been your decision to bring together (join) the data in the tables.</p>
<p>In order to do this at all you must be confident that the tables of data do have columns which have a common set of values that you can join on.</p>
<p>Assuming you do have a common column to join on, you can use an <code>Inner join</code> to combine the data.</p>
<p>However it will also be important for you to establish rows in both of the tables for which there is no matching row in the other table.</p>
<ul>
<li>You may expect some to be missing</li>
<li>You may not care that some are missing</li>
<li>You may need to explain why some are missing</li>
</ul>
<p>To do this you will want to use a <code>Full outer join</code> or in the case of SQLite a <code>Left outer join</code> run twice using both tables in the <code>From</code> and <code>Join</code> clauses.</p>
<p>We can demonstrate the <code>Left outer join</code> using the Crops_rice table we created earlier.</p>
<p>The query below is similar to our original join except that we are now joining with the crops_rice table and we have dropped the additional criteria.</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>Id <span class="token keyword">as</span> Farms_Id<span class="token punctuation">,</span> a<span class="token punctuation">.</span>B_no_membrs<span class="token punctuation">,</span>
       b<span class="token punctuation">.</span>Id <span class="token keyword">as</span> Crops_Id<span class="token punctuation">,</span> b<span class="token punctuation">.</span>D_curr_crop
<span class="token keyword">from</span> Farms <span class="token keyword">as</span> a
<span class="token keyword">left</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> Crops_rice <span class="token keyword">as</span> b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>Id <span class="token operator">=</span> b<span class="token punctuation">.</span>Id 
</pre><p>You can see from the results that there is an entry for every record in the Farms table, but unless there is a crop of rice, the entries in the columns from the crops_rice table are shown as <code>NULL</code>.</p>
<p><img src="./fig/SQL_09_Left_Outer_Join_1.png" alt="Left Outer Join1"></p>
<h3 class="mume-header" id="joins-with-more-than-two-tables">Joins with more than two tables</h3>

<p>Joins are not restricted to just two tables. You can have any number, but the more you have the more unreadable the SQL query is likely to become. Quite often you can create views to hide this complexity.</p>
<p>Our original question was: &apos;Which Farms with more than 12 people in the household grow Maize?&apos; We found the number of people in the household from the Farms table and the crops they grew in the crops table. Suppose we now wanted to change the question to be: For Farms with more than 12 people in the household how much land is devoted to growing Maize? In addition to the previous requirements we now also need the size of the plots growing maize. This information is only contained in the <code>plots</code> table. The <code>plots</code> table has both an Id column which we can use to join it with the Farms column. There is also a plot_Id column which is used to indicate the number of the plot within the Farm. The <code>crops</code> table also has a plot_id column used for the same purpose.</p>
<p>However we cannot join the <code>plots</code> and the <code>crops</code> table with just the <code>plot_id</code> column because the <code>plot_id</code> column is not unique within the Plots table. The <code>plot_id</code> is the plot number within a Farm. So every Farm will have a plot_id with the value 1. In order to make what we join on unique we need to use both the Id column and the plot_id column together. This is allowed and quite commonly done.</p>
<p>Our new query now looks like this:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>Id <span class="token keyword">as</span> Farms_Id<span class="token punctuation">,</span> a<span class="token punctuation">.</span>B_no_membrs<span class="token punctuation">,</span>
       b<span class="token punctuation">.</span>Id <span class="token punctuation">,</span> b<span class="token punctuation">.</span>plot_id <span class="token keyword">as</span> plot_id<span class="token punctuation">,</span> b<span class="token punctuation">.</span>D02_total_plot<span class="token punctuation">,</span>
       c<span class="token punctuation">.</span>Id <span class="token keyword">as</span> Crops_Id<span class="token punctuation">,</span> c<span class="token punctuation">.</span>plot_Id <span class="token keyword">as</span> crops_plot_id<span class="token punctuation">,</span> c<span class="token punctuation">.</span>D_curr_crop
<span class="token keyword">from</span> Farms <span class="token keyword">as</span> a
<span class="token keyword">join</span> Plots <span class="token keyword">as</span> b
<span class="token keyword">join</span> Crops  <span class="token keyword">as</span> c
<span class="token keyword">on</span> a<span class="token punctuation">.</span>Id <span class="token operator">=</span> b<span class="token punctuation">.</span>Id <span class="token operator">and</span> <span class="token punctuation">(</span> b<span class="token punctuation">.</span>Id <span class="token operator">=</span> c<span class="token punctuation">.</span>Id <span class="token operator">and</span> b<span class="token punctuation">.</span>plot_id <span class="token operator">=</span> c<span class="token punctuation">.</span>plot_id<span class="token punctuation">)</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>B_no_membrs <span class="token operator">&gt;</span> <span class="token number">12</span> <span class="token operator">and</span> c<span class="token punctuation">.</span>D_curr_crop <span class="token operator">=</span> <span class="token string">&apos;maize&apos;</span>
<span class="token punctuation">;</span>
</pre><p>Things to notice:</p>
<ol>
<li>There is a <code>join</code> clause for each of the additional tables</li>
<li>But there is only one <code>on</code> clause containing all of the needed criteria.</li>
<li>The two criteria in brackets represents the join of the <code>plots</code> table to the <code>Crops</code> table. (The brackets aren&apos;t needed, I just added them for clarity).</li>
</ol>
<p>The results look like this:</p>
<p><img src="./fig/SQL_09_join5.png" alt="Left Outer Join1"></p>
<blockquote>
<h3>Exercise</h3>
<ol>
<li>Modify the query above so that only the &apos;Id&apos;, &apos;D02_total_plot&apos; and the &apos;D_curr_crop&apos; columns are shown and at the same time summarise the data so that there is only one entry for each Farm.<br>
i.e sum the &apos;D02_total_plot&apos; column.</li>
</ol>
</blockquote>
<details><summary><b>Solution</b>  - click me</summary>
<h3>Solution</h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>Id <span class="token keyword">as</span> Farms_Id<span class="token punctuation">,</span> 
      <span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>D02_total_plot<span class="token punctuation">)</span> <span class="token keyword">as</span> total_planted<span class="token punctuation">,</span>
      c<span class="token punctuation">.</span>D_curr_crop
<span class="token keyword">from</span> Farms <span class="token keyword">as</span> a
<span class="token keyword">join</span> Plots <span class="token keyword">as</span> b
<span class="token keyword">join</span> Crops  <span class="token keyword">as</span> c
<span class="token keyword">on</span> a<span class="token punctuation">.</span>Id <span class="token operator">=</span> b<span class="token punctuation">.</span>Id <span class="token operator">and</span> <span class="token punctuation">(</span> b<span class="token punctuation">.</span>Id <span class="token operator">=</span> c<span class="token punctuation">.</span>Id <span class="token operator">and</span> b<span class="token punctuation">.</span>plot_id <span class="token operator">=</span> c<span class="token punctuation">.</span>plot_id<span class="token punctuation">)</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>B_no_membrs <span class="token operator">&gt;</span> <span class="token number">12</span> <span class="token operator">and</span> c<span class="token punctuation">.</span>D_curr_crop <span class="token operator">=</span> <span class="token string">&apos;maize&apos;</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> c<span class="token punctuation">.</span>D_curr_crop
<span class="token punctuation">;</span>
</pre></details>
<br>

      </div>
      
      
    
    
    
    
    
    
    
    
  
    </body></html>